<!DOCTYPE html>
<html>
  <head>
    <title>Transformer Zoo</title>
    <link rel="stylesheet" href="/static/styles.css">
  </head>
  <body>
    <div class="container">
      <h1>Collaborative Transformer Zoo</h1>
      
      <!-- Auth Section -->
      <div class="auth-section">
        <div class="user-info" id="user-info">
          Logged in as: <strong id="username-display"></strong> 
          <button class="btn btn-secondary" onclick="logout()" style="float: right;">Logout</button>
        </div>
        <div id="auth-forms">
          <h3>Account</h3>
          <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchTab('login')">Login</button>
            <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
          </div>
          
          <!-- Login Form -->
          <form class="auth-form active" id="login-form" onsubmit="handleLogin(event)">
            <input type="text" placeholder="Username" id="login-username" required>
            <input type="password" placeholder="Password" id="login-password" required>
            <button type="submit" class="btn btn-primary">Login</button>
            <p id="login-error" style="color: red; display: none;"></p>
          </form>
          
          <!-- Signup Form -->
          <form class="auth-form" id="signup-form" onsubmit="handleSignup(event)">
            <input type="text" placeholder="Username" id="signup-username" required>
            <input type="email" placeholder="Email" id="signup-email" required>
            <input type="password" placeholder="Password" id="signup-password" required>
            <button type="submit" class="btn btn-primary">Sign Up</button>
            <p id="signup-error" style="color: red; display: none;"></p>
          </form>
        </div>
      </div>

      <!-- Visualization Form -->
      <form action="/visualize" method="post">
        <label><strong>Model Name:</strong></label>
        <input type="text" name="model_name" value="google/gemma-2b">
        <label><strong>View Type:</strong></label>
        <select name="view_type" style="margin-bottom: 1rem; padding: 5px;">
          <option value="head">Head View (Lines)</option>
          <option value="model">Model View (Blocks)</option>
        </select>
        <br><label><strong>Input Text:</strong></label>
        <textarea name="text">The cat sat on the mat.</textarea>
        <button type="submit" class="btn btn-primary">Visualize</button>
      </form>

      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;">
        <a href="/visualizations" class="btn btn-outline">Browse All Visualizations</a>
      </div>
    </div>

    <script>
      window.addEventListener('load', checkLoginStatus);

      function checkLoginStatus() {
        const token = localStorage.getItem('auth_token');
        const username = localStorage.getItem('username');
        if (token && username) {
          document.getElementById('auth-forms').style.display = 'none';
          document.getElementById('user-info').classList.add('active');
          document.getElementById('username-display').textContent = username;
        }
      }

      function switchTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + '-form').classList.add('active');
      }

      async function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');

        try {
          const formData = new FormData();
          formData.append('username', username);
          formData.append('password', password);

          const res = await fetch('/auth/login', {
            method: 'POST',
            body: formData
          });

          if (res.ok) {
            const data = await res.json();
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('username', username);
            errorEl.style.display = 'none';
            checkLoginStatus();
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
          } else {
            const error = await res.json();
            errorEl.textContent = error.detail || 'Login failed';
            errorEl.style.display = 'block';
          }
        } catch (err) {
          errorEl.textContent = 'Error: ' + err.message;
          errorEl.style.display = 'block';
        }
      }

      async function handleSignup(event) {
        event.preventDefault();
        const username = document.getElementById('signup-username').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const errorEl = document.getElementById('signup-error');

        try {
          const formData = new FormData();
          formData.append('username', username);
          formData.append('email', email);
          formData.append('password', password);

          const res = await fetch('/auth/signup', {
            method: 'POST',
            body: formData
          });

          if (res.ok) {
            const data = await res.json();
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('username', username);
            errorEl.style.display = 'none';
            checkLoginStatus();
            document.getElementById('signup-username').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
          } else {
            const error = await res.json();
            errorEl.textContent = error.detail || 'Signup failed';
            errorEl.style.display = 'block';
          }
        } catch (err) {
          errorEl.textContent = 'Error: ' + err.message;
          errorEl.style.display = 'block';
        }
      }

      function logout() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('username');
        document.getElementById('user-info').classList.remove('active');
        document.getElementById('auth-forms').style.display = 'block';
        location.reload();
      }
    </script>
  </body>
</html>
